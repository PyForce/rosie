L.Polyline.plotter=L.Polyline.extend({_lineMarkers:[],_editIcon:L.divIcon({className:"leaflet-div-icon leaflet-editing-icon"}),_halfwayPointMarkers:[],_existingLatLngs:[],options:{weight:2,color:"#000",readOnly:false},initialize:function(e,t){this._setExistingLatLngs(e);L.Polyline.prototype.initialize.call(this,[],t)},onAdd:function(e){L.Polyline.prototype.onAdd.call(this,e);this._map=e;this._plotExisting();if(!this.options.readOnly){this._bindMapClick()}},onRemove:function(){for(index in this._halfwayPointMarkers){this._map.removeLayer(this._halfwayPointMarkers[index])}for(index in this._lineMarkers){this._map.removeLayer(this._lineMarkers[index])}this._halfwayPointMarkers=this._lineMarkers=[];this._unbindMapClick();L.Polyline.prototype.onRemove.call(this,map)},setLatLngs:function(e){L.Polyline.prototype.setLatLngs.call(this,e)},setReadOnly:function(e){if(e&&!this.options.readOnly){var t="_unbindMarkerEvents";var n="_unbindHalfwayMarker";this._unbindMapClick()}else if(!e&&this.options.readOnly){var t="_bindMarkerEvents";var n="_bindMarkerEvents";this._bindMapClick()}if(typeof t!=="undefined"){this.options.readOnly=e;for(index in this._halfwayPointMarkers){this[n](this._halfwayPointMarkers[index])}for(index in this._lineMarkers){this[t](this._lineMarkers[index])}}},_bindMapClick:function(){this._map.on("click",this._onMapClick,this)},_unbindMapClick:function(){this._map.off("click",this._onMapClick,this)},_setExistingLatLngs:function(e){this._existingLatLngs=e},_replot:function(){this._redraw();this._redrawHalfwayPoints()},_getNewMarker:function(e,t){return new L.marker(e,t)},_unbindMarkerEvents:function(e){e.off("click",this._removePoint,this);e.off("drag",this._replot,this);e.dragging.disable()},_bindMarkerEvents:function(e){e.on("click",this._removePoint,this);e.on("drag",this._replot,this);e.dragging.enable()},_bindHalfwayMarker:function(e){e.on("click",this._addHalfwayPoint,this)},_unbindHalfwayMarker:function(e){e.off("click",this._addHalfwayPoint,this)},_addToMapAndBindMarker:function(e){e.addTo(this._map);if(!this.options.readOnly){this._bindMarkerEvents(e)}},_removePoint:function(e){this._map.removeLayer(this._lineMarkers[this._lineMarkers.indexOf(e.target)]);this._lineMarkers.splice(this._lineMarkers.indexOf(e.target),1);this._replot()},_onMapClick:function(e){this._addNewMarker(e);this._replot()},_addNewMarker:function(e){var t=this._getNewMarker(e.latlng,{icon:this._editIcon});this._addToMapAndBindMarker(t);this._lineMarkers.push(t)},_redrawHalfwayPoints:function(){for(index in this._halfwayPointMarkers){this._map.removeLayer(this._halfwayPointMarkers[index])}this._halfwayPointMarkers=[];for(index in this._lineMarkers){index=parseInt(index);if(typeof this._lineMarkers[index+1]==="undefined"){return}var e=(new L.Marker([(this._lineMarkers[index].getLatLng().lat+this._lineMarkers[index+1].getLatLng().lat)/2,(this._lineMarkers[index].getLatLng().lng+this._lineMarkers[index+1].getLatLng().lng)/2],{icon:this._editIcon,opacity:.5})).addTo(this._map);e.index=index;if(!this.options.readOnly){this._bindHalfwayMarker(e)}this._halfwayPointMarkers.push(e)}},_addHalfwayPoint:function(e){var t=this._getNewMarker(e.latlng,{icon:this._editIcon});this._addToMapAndBindMarker(t);this._lineMarkers.splice(e.target.index+1,0,t);this._replot()},_plotExisting:function(){for(index in this._existingLatLngs){this._addNewMarker({latlng:new L.LatLng(this._existingLatLngs[index][0],this._existingLatLngs[index][1])})}this._replot()},_redraw:function(){this.setLatLngs([]);this.redraw();for(index in this._lineMarkers){this.addLatLng(this._lineMarkers[index].getLatLng())}this.redraw()}});L.Polyline.Plotter=function(e,t){return new L.Polyline.plotter(e,t)}